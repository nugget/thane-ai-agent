{{define "title"}}{{.BrandName}} - Chat{{end}}

{{define "head"}}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <style>
        /* Chat page overrides â€” fill available space below the nav */
        body { height: 100vh; display: flex; flex-direction: column; }
        main { flex: 1; display: flex; flex-direction: column; padding: 0; max-width: none; overflow: hidden; }

        .chat-status-bar {
            padding: 4px 16px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 11px;
            color: var(--text-muted);
        }
        .chat-status-bar .context-area {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chat-status-bar .context-bar-track {
            flex: 1;
            max-width: 200px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
        }
        .chat-status-bar .context-bar-fill {
            height: 100%;
            background: var(--teal);
            border-radius: 2px;
            width: 0%;
            transition: width 0.3s;
        }
        .chat-status-bar button {
            background: none;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-muted);
            font-size: 10px;
            padding: 2px 8px;
            cursor: pointer;
        }
        .chat-status-bar button:hover { border-color: var(--teal); color: var(--text); }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.5;
        }
        .message.user {
            align-self: flex-end;
            background: var(--teal);
            color: #000;
            border-bottom-right-radius: 4px;
        }
        .message.assistant {
            align-self: flex-start;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
        }
        .message.assistant .content { overflow-wrap: break-word; }
        .message.assistant p { margin-bottom: 12px; }
        .message.assistant p:last-child { margin-bottom: 0; }
        .message.assistant h1, .message.assistant h2, .message.assistant h3 {
            margin: 16px 0 8px 0; color: var(--teal);
        }
        .message.assistant h1:first-child, .message.assistant h2:first-child, .message.assistant h3:first-child { margin-top: 0; }
        .message.assistant ul, .message.assistant ol { margin: 8px 0 8px 20px; }
        .message.assistant li { margin: 4px 0; }
        .message.assistant a { color: var(--teal); }
        .message.assistant strong { color: var(--teal); }
        .code-block { position: relative; margin: 12px 0; }
        .code-block:last-child { margin-bottom: 0; }
        .code-block pre {
            background: #1a1f26;
            border-radius: 8px;
            padding: 12px;
            overflow-x: auto;
            border: 1px solid var(--border);
        }
        .code-block code {
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 13px; line-height: 1.4;
        }
        .code-header {
            display: flex; justify-content: space-between; align-items: center;
            background: #21262d; border: 1px solid var(--border); border-bottom: none;
            border-radius: 8px 8px 0 0; padding: 6px 12px;
            font-size: 12px; color: var(--text-muted);
        }
        .code-header + pre { border-top-left-radius: 0; border-top-right-radius: 0; }
        .copy-btn {
            background: transparent; border: 1px solid var(--border);
            color: var(--text-muted); padding: 4px 8px; border-radius: 4px;
            cursor: pointer; font-size: 11px; transition: all 0.2s;
        }
        .copy-btn:hover, .copy-btn.copied { background: var(--teal); color: #000; border-color: var(--teal); }
        .message.assistant code:not(pre code) {
            background: #1a1f26; padding: 2px 6px; border-radius: 4px;
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; font-size: 0.9em;
        }
        .message.assistant table { border-collapse: collapse; margin: 12px 0; width: 100%; }
        .message.assistant th, .message.assistant td {
            border: 1px solid var(--border); padding: 8px 12px; text-align: left;
        }
        .message.assistant th { background: #21262d; color: var(--teal); }

        .input-area {
            padding: 16px 20px;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
        }
        .input-container { display: flex; gap: 12px; max-width: 900px; margin: 0 auto; }
        .input-wrapper { flex: 1; position: relative; }
        #message-input {
            width: 100%; padding: 12px 16px; background: var(--bg);
            border: 1px solid var(--border); border-radius: 12px;
            color: var(--text); font-size: 15px; resize: none;
            min-height: 48px; max-height: 200px; font-family: inherit; line-height: 1.4;
        }
        #message-input:focus { outline: none; border-color: var(--teal); box-shadow: 0 0 0 3px rgba(0,200,180,0.15); }
        #message-input::placeholder { color: var(--text-muted); }
        #send-btn {
            padding: 12px 24px; background: var(--teal); border: none; border-radius: 12px;
            color: #000; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        #send-btn:hover { filter: brightness(0.9); }
        #send-btn:disabled { background: #21262d; color: var(--text-muted); cursor: not-allowed; }

        .thinking { display: flex; align-items: center; gap: 8px; color: var(--text-muted); font-size: 0.85rem; font-style: italic; }
        .thinking-pulse { width: 8px; height: 8px; border-radius: 50%; background: var(--teal); animation: pulse 1.5s ease-in-out infinite; }
        @keyframes pulse { 0%,100%{opacity:.3;transform:scale(.8)} 50%{opacity:1;transform:scale(1.2)} }
        .typing { display: flex; gap: 4px; padding: 8px 12px; }
        .typing span { width: 8px; height: 8px; background: var(--teal); border-radius: 50%; animation: typing 1.4s infinite; }
        .typing span:nth-child(2) { animation-delay: .2s; }
        .typing span:nth-child(3) { animation-delay: .4s; }
        @keyframes typing { 0%,60%,100%{transform:translateY(0);opacity:.4} 30%{transform:translateY(-4px);opacity:1} }

        @media (max-width: 600px) { .message { max-width: 95%; } }
    </style>
{{end}}

{{define "content"}}
<div class="chat-status-bar">
    <div class="context-area">
        <span id="context-label">Context: â€”</span>
        <div class="context-bar-track">
            <div id="context-fill" class="context-bar-fill"></div>
        </div>
        <span id="context-pct" style="min-width:30px;">0%</span>
    </div>
    <span id="stats-text" style="cursor:pointer;" title="Click to refresh">â€”</span>
    <button id="btn-compact" title="Save memories and compact context">ðŸ“¦ Compact</button>
    <button id="btn-reset" title="Reset conversation">âŸ³ Reset</button>
</div>

<div class="messages" id="messages"></div>

<div class="input-area">
    <div class="input-container">
        <div class="input-wrapper">
            <textarea id="message-input" placeholder="Message {{.BrandName}}..." rows="1"></textarea>
        </div>
        <button id="send-btn">Send</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');

    let sessionId = sessionStorage.getItem('thane-session-id');
    if (!sessionId) {
        sessionId = crypto.randomUUID();
        sessionStorage.setItem('thane-session-id', sessionId);
    }

    let conversationHistory = [];

    // sanitizeLang whitelists code-fence language identifiers to prevent
    // injection via attacker-controlled markdown info strings.
    function sanitizeLang(lang) {
        if (typeof lang !== 'string') return 'plaintext';
        return /^[A-Za-z0-9_+\-]+$/.test(lang) ? lang : 'plaintext';
    }

    // escapeHTML prevents raw HTML in markdown from executing in the
    // browser (mitigates stored/self-XSS from LLM responses).
    function escapeHTML(s) {
        const el = document.createElement('span');
        el.textContent = s;
        return el.innerHTML;
    }

    marked.setOptions({
        highlight: function(code, lang) {
            const safe = sanitizeLang(lang);
            if (hljs.getLanguage(safe)) return hljs.highlight(code, { language: safe }).value;
            return hljs.highlightAuto(code).value;
        },
        breaks: true, gfm: true
    });

    const renderer = new marked.Renderer();
    renderer.code = function(code, language) {
        const lang = sanitizeLang(language);
        const highlighted = hljs.getLanguage(lang)
            ? hljs.highlight(code, { language: lang }).value
            : hljs.highlightAuto(code).value;
        const id = 'code-' + Math.random().toString(36).substr(2, 9);
        return '<div class="code-block"><div class="code-header"><span>' + escapeHTML(lang) + '</span>' +
            '<button class="copy-btn" onclick="copyCode(\'' + id + '\')">Copy</button></div>' +
            '<pre><code id="' + id + '" class="hljs language-' + lang + '">' + highlighted + '</code></pre></div>';
    };
    // Escape raw HTML in LLM markdown to prevent XSS.
    renderer.html = function(html) { return escapeHTML(html); };
    marked.setOptions({ renderer });

    function copyCode(id) {
        const codeEl = document.getElementById(id);
        navigator.clipboard.writeText(codeEl.textContent).then(() => {
            const btn = codeEl.closest('.code-block').querySelector('.copy-btn');
            btn.textContent = 'Copied!';
            btn.classList.add('copied');
            setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
        });
    }

    function addMessage(role, content) {
        const msgEl = document.createElement('div');
        msgEl.className = 'message ' + role;
        if (role === 'assistant') {
            const contentEl = document.createElement('div');
            contentEl.className = 'content';
            contentEl.innerHTML = marked.parse(content);
            msgEl.appendChild(contentEl);
        } else {
            msgEl.textContent = content;
        }
        messagesEl.appendChild(msgEl);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        conversationHistory.push({ role, content });
        return msgEl;
    }

    function addThinkingIndicator() {
        const el = document.createElement('div');
        el.className = 'message assistant';
        el.id = 'thinking-indicator';
        el.innerHTML = '<div class="thinking"><span class="thinking-pulse"></span> Thinkingâ€¦</div>';
        messagesEl.appendChild(el);
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function transitionToTyping() {
        const el = document.getElementById('thinking-indicator');
        if (el) {
            el.id = 'typing-indicator';
            el.innerHTML = '<div class="typing"><span></span><span></span><span></span></div>';
        }
    }

    function removeIndicator() {
        const el = document.getElementById('thinking-indicator') || document.getElementById('typing-indicator');
        if (el) el.remove();
    }

    async function sendMessage() {
        const content = inputEl.value.trim();
        if (!content) return;
        inputEl.value = '';
        inputEl.style.height = 'auto';
        sendBtn.disabled = true;

        addMessage('user', content);
        addThinkingIndicator();

        try {
            const response = await fetch('/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    messages: conversationHistory.map(m => ({ role: m.role, content: m.content })),
                    conversation_id: sessionId,
                    stream: true
                })
            });

            if (!response.ok) { removeIndicator(); throw new Error('HTTP ' + response.status); }
            transitionToTyping();

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let assistantContent = '';
            let msgEl = null;

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value, { stream: true });
                for (const line of chunk.split('\n')) {
                    if (!line.startsWith('data: ')) continue;
                    const data = line.slice(6).trim();
                    if (data === '[DONE]') continue;
                    try {
                        const parsed = JSON.parse(data);
                        const delta = parsed.choices?.[0]?.delta?.content;
                        if (delta) {
                            assistantContent += delta;
                            if (!msgEl) { removeIndicator(); msgEl = addMessage('assistant', assistantContent); }
                            else {
                                const contentEl = msgEl.querySelector('.content');
                                if (contentEl) contentEl.innerHTML = marked.parse(assistantContent);
                                messagesEl.scrollTop = messagesEl.scrollHeight;
                            }
                        }
                    } catch (e) {}
                }
            }

            if (!msgEl && !assistantContent) {
                addMessage('assistant', 'No response');
            } else if (assistantContent) {
                const lastEntry = conversationHistory[conversationHistory.length - 1];
                if (lastEntry && lastEntry.role === 'assistant') lastEntry.content = assistantContent;
            }
        } catch (error) {
            removeIndicator();
            addMessage('assistant', '*Error: ' + error.message + '*');
        }
        sendBtn.disabled = false;
        inputEl.focus();
        refreshStats();
    }

    sendBtn.addEventListener('click', sendMessage);
    inputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });
    inputEl.addEventListener('input', () => {
        inputEl.style.height = 'auto';
        inputEl.style.height = Math.min(inputEl.scrollHeight, 200) + 'px';
    });

    const statsEl = document.getElementById('stats-text');
    const contextLabel = document.getElementById('context-label');
    const contextFill = document.getElementById('context-fill');
    const contextPct = document.getElementById('context-pct');

    async function refreshStats() {
        try {
            const resp = await fetch('/v1/session/stats');
            const data = await resp.json();
            const cost = data.estimated_cost_usd.toFixed(4);
            const reqs = data.total_requests;
            const inTok = (data.total_input_tokens / 1000).toFixed(1);
            const outTok = (data.total_output_tokens / 1000).toFixed(1);
            let text = '$' + cost + ' Â· ' + reqs + ' req Â· ' + inTok + 'k/' + outTok + 'k tokens';
            if (data.reported_balance_usd > 0) {
                text = '~$' + (data.reported_balance_usd - data.estimated_cost_usd).toFixed(2) + ' remaining Â· ' + text;
            }
            statsEl.textContent = text;

            if (data.context_window > 0) {
                const ctxK = (data.context_tokens / 1000).toFixed(1);
                const winK = (data.context_window / 1000).toFixed(0);
                const pctVal = Math.min(100, (data.context_tokens / data.context_window) * 100);
                contextLabel.textContent = 'Context: ~' + ctxK + 'k / ' + winK + 'k Â· ' + data.message_count + ' msgs';
                contextFill.style.width = pctVal + '%';
                contextPct.textContent = pctVal.toFixed(0) + '%';
                if (pctVal > 80) contextFill.style.background = '#f85149';
                else if (pctVal > 60) contextFill.style.background = '#f39c12';
                else contextFill.style.background = 'var(--teal)';
            }
        } catch (e) { statsEl.textContent = 'â€”'; }
    }

    statsEl.addEventListener('click', refreshStats);

    document.getElementById('btn-compact').addEventListener('click', async () => {
        if (!confirm('Compact session? This will save memories, then compress the conversation.')) return;
        const btn = document.getElementById('btn-compact');
        btn.disabled = true;
        btn.textContent = 'â³ Flushingâ€¦';
        try {
            const flushResp = await fetch('/v1/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'thane',
                    messages: [{ role: 'user', content: '[SYSTEM] Pre-compaction memory flush. Review this conversation for anything important. Write significant events, decisions, or context to today\'s memory file. Then respond with a brief summary of what you saved.' }],
                    stream: false
                })
            });
            const flushData = await flushResp.json();
            if (flushData.choices && flushData.choices[0]) addMessage('assistant', flushData.choices[0].message.content);

            btn.textContent = 'â³ Compactingâ€¦';
            const compactResp = await fetch('/v1/session/compact', { method: 'POST' });
            const compactData = await compactResp.json();
            if (compactData.status === 'ok') addMessage('assistant', '*âœ… Conversation compacted.*');
            else addMessage('assistant', '*âš ï¸ Compaction failed: ' + (compactData.error || 'unknown') + '*');
            refreshStats();
        } catch (e) {
            addMessage('assistant', '*âš ï¸ Compact failed: ' + e.message + '*');
        } finally {
            btn.disabled = false;
            btn.textContent = 'ðŸ“¦ Compact';
        }
    });

    document.getElementById('btn-reset').addEventListener('click', async () => {
        if (!confirm('Reset conversation? This clears all chat history.')) return;
        try {
            await fetch('/v1/session/reset', { method: 'POST' });
            messagesEl.innerHTML = '';
            conversationHistory = [];
            refreshStats();
        } catch (e) { alert('Reset failed: ' + e.message); }
    });

    refreshStats();
    setInterval(refreshStats, 30000);

    async function loadHistory() {
        try {
            const resp = await fetch('/v1/session/history');
            const data = await resp.json();
            if (data.messages && data.messages.length > 0) {
                for (const msg of data.messages) addMessage(msg.role, msg.content);
                messagesEl.scrollTop = messagesEl.scrollHeight;
            }
        } catch (e) { console.log('Failed to load history:', e); }
    }
    loadHistory();
    inputEl.focus();
</script>
{{end}}
